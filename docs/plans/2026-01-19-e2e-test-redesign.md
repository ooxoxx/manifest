# 前端 E2E 测试重设计方案

> **版本**: 1.0.0
> **日期**: 2026-01-19
> **状态**: 已确认
> **关联**: [前端 UX 重设计方案](./2026-01-19-frontend-ux-redesign.md)

---

## 1. 设计目标

根据前端 UX 重设计方案，完全替换现有 E2E 测试，确保：

- 所有新路由和页面可访问
- 关键 UI 元素正确渲染
- 基本交互功能可用

### 测试策略

- **完全替换**：删除现有测试，从零编写
- **广度优先**：每个模块覆盖页面可达性、UI 元素、基本交互
- **测试总数**：77 个测试用例

---

## 2. 文件结构

```
frontend/tests/
├── auth.setup.ts              # 认证 setup（复用现有）
├── config.ts                  # 环境配置（复用现有）
├── navigation.spec.ts         # 侧边栏导航、路由重定向
├── auth/
│   ├── login.spec.ts          # 登录（6 个测试）
│   ├── sign-up.spec.ts        # 注册（5 个测试）
│   └── reset-password.spec.ts # 密码重置（3 个测试）
├── workbench/
│   ├── import.spec.ts         # 样本入库向导（8 个测试）
│   ├── build.spec.ts          # 数据集构建向导（10 个测试）
│   ├── ops.spec.ts            # 运维中心（5 个测试）
│   ├── samples.spec.ts        # 样本浏览（7 个测试）
│   └── datasets.spec.ts       # 数据集浏览（6 个测试）
├── settings/
│   ├── tags.spec.ts           # 标签管理（5 个测试）
│   ├── minio.spec.ts          # MinIO 实例（5 个测试）
│   ├── users.spec.ts          # 用户管理（4 个测试）
│   └── profile.spec.ts        # 个人设置（5 个测试）
└── utils/                     # 复用现有工具函数
    ├── user.ts
    ├── random.ts
    ├── mailcatcher.ts
    └── privateApi.ts
```

### 复用与删除

- **复用**：auth.setup.ts、config.ts、utils/ 目录
- **删除**：现有 tests/*.spec.ts 文件（9 个文件）
- **新建**：13 个测试文件

---

## 3. 认证模块测试

### auth/login.spec.ts（6 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/login`，登录表单可见 |
| 有效凭据登录成功 | 填写正确邮箱密码，跳转到 `/ops` |
| 无效邮箱格式提示错误 | 输入非法邮箱，显示验证错误 |
| 错误密码提示错误 | 输入错误密码，显示认证失败 |
| 空字段提交被阻止 | 不填写直接提交，显示必填提示 |
| 已登录用户访问登录页重定向 | 已认证状态访问 `/login`，重定向到 `/ops` |

### auth/sign-up.spec.ts（5 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问注册页，表单可见 |
| 有效信息注册成功 | 填写有效信息，注册成功 |
| 邮箱已存在提示错误 | 使用已注册邮箱，显示重复提示 |
| 密码不匹配提示错误 | 两次密码不一致，显示错误 |
| 弱密码提示错误 | 密码少于 8 位，显示强度提示 |

### auth/reset-password.spec.ts（3 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问重置页，邮箱输入框可见 |
| 发送重置邮件成功 | 输入有效邮箱，显示发送成功提示 |
| 重置链接可用 | 从 Mailcatcher 获取链接，访问后可设置新密码 |

---

## 4. 导航测试

### navigation.spec.ts（8 个测试）

**路由重定向**

| 测试 | 说明 |
|------|------|
| 根路径重定向到运维中心 | 访问 `/`，重定向到 `/ops` |
| 未登录访问受保护路由重定向到登录页 | 未认证访问 `/ops`，重定向到 `/login` |

**侧边栏导航 — 工作台区域**

| 测试 | 说明 |
|------|------|
| 点击"样本入库"跳转到 /import | 侧边栏点击，URL 变为 `/import` |
| 点击"数据集构建"跳转到 /build | 侧边栏点击，URL 变为 `/build` |
| 点击"运维中心"跳转到 /ops | 侧边栏点击，URL 变为 `/ops` |
| 点击"样本浏览"跳转到 /samples | 侧边栏点击，URL 变为 `/samples` |
| 点击"数据集浏览"跳转到 /datasets | 侧边栏点击，URL 变为 `/datasets` |

**侧边栏导航 — 配置区域**

| 测试 | 说明 |
|------|------|
| 点击"标签管理"跳转到 /settings/tags | 侧边栏点击，URL 变为 `/settings/tags` |
| 点击"MinIO 实例"跳转到 /settings/minio | 侧边栏点击，URL 变为 `/settings/minio` |
| 用户管理仅管理员可见 | 非管理员登录，侧边栏不显示"用户管理" |

---

## 5. 工作台模块测试

### workbench/import.spec.ts（8 个测试）

**页面与向导结构**

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/import`，显示向导标题和步骤指示器 |
| 步骤指示器显示 4 步 | 显示：上传、验证、标签、确认 |

**步骤 1：上传 CSV**

| 测试 | 说明 |
|------|------|
| MinIO 实例选择器可用 | 下拉框可见，可选择实例 |
| CSV 文件上传 | 选择文件后显示文件名，"下一步"可点击 |

**步骤 2：验证文件**

| 测试 | 说明 |
|------|------|
| 显示验证结果 | 进入步骤 2 后显示存在/缺失/重复统计 |
| 可返回上一步 | 点击"上一步"回到步骤 1 |

**步骤 3：关联标签**

| 测试 | 说明 |
|------|------|
| 标签选择器可用 | 可选择或创建标签 |

**步骤 4：确认入库**

| 测试 | 说明 |
|------|------|
| 显示汇总预览 | 显示将创建的样本数 |
| 点击"开始入库"完成流程 | 点击后显示成功提示或进度 |

### workbench/build.spec.ts（10 个测试）

**页面与向导结构**

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/build`，显示向导标题和步骤指示器 |
| 步骤指示器显示 5 步 | 显示：基本信息、筛选条件、采样配比、预览审核、确认生成 |

**步骤 1：基本信息**

| 测试 | 说明 |
|------|------|
| 名称为必填字段 | 不填名称点击下一步，显示验证错误 |
| 填写名称和描述后可进入下一步 | 填写后点击"下一步"进入步骤 2 |

**步骤 2：筛选条件**

| 测试 | 说明 |
|------|------|
| 筛选面板可用 | 标签、时间、标注状态等筛选器可见 |
| 筛选后显示预估匹配数 | 设置筛选条件后显示匹配样本数量 |

**步骤 3：采样配比**

| 测试 | 说明 |
|------|------|
| 采样模式切换 | 可在"全部"和"随机采样"间切换 |
| 随机采样可设置数量和种子 | 选择随机采样后，数量和种子输入框可用 |

**步骤 4：预览审核**

| 测试 | 说明 |
|------|------|
| 列表模式显示候选样本 | 默认显示表格列表 |
| 可切换到逐张模式 | 点击切换按钮，显示单张大图和快捷键提示 |

**步骤 5：确认生成**

| 测试 | 说明 |
|------|------|
| 显示汇总统计 | 显示最终样本数 |
| 点击确认创建数据集 | 点击后跳转到数据集浏览或显示成功提示 |

### workbench/ops.spec.ts（5 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/ops`，显示"运维中心"标题 |
| 统计卡片可见 | 显示样本总量、已标注、本周新增、存储实例卡片 |
| 时间范围选择器可用 | 可切换今日/本周/本月 |
| 样本增长趋势图可见 | 显示折线图区域 |
| 点击统计卡片跳转到样本浏览 | 点击"样本总量"卡片，跳转到 `/samples` |

### workbench/samples.spec.ts（7 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/samples`，显示样本列表 |
| 筛选条件栏可见 | 标签、时间、标注状态筛选器可见 |
| 列表显示缩略图和基本信息 | 表格包含缩略图、文件名、标注状态列 |
| 勾选样本后显示批量操作栏 | 勾选后顶部出现"添加到数据集"按钮 |
| 点击行切换到逐张模式 | 点击某行，进入逐张浏览模式 |
| 逐张模式显示大图和信息 | 显示图像、bbox 叠加、文件信息 |
| 键盘 ←→ 可翻页，ESC 返回列表 | 逐张模式下键盘操作正常 |

### workbench/datasets.spec.ts（6 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/datasets`，显示数据集列表 |
| 列表显示名称、样本数、创建时间 | 表格包含必要列 |
| "新建数据集"按钮跳转到构建向导 | 点击后跳转到 `/build` |
| 点击"查看"展开样本列表 | 点击后显示该数据集的样本 |
| 点击"审核"进入审核模式 | 跳转到 `/datasets/:id/review` |
| 审核模式支持保留/移除操作 | 显示审核界面，操作按钮可用 |

---

## 6. 配置模块测试

### settings/tags.spec.ts（5 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/settings/tags`，显示标签管理界面 |
| 标签树可见 | 左侧显示层级标签树 |
| 点击标签显示详情 | 右侧显示关联样本数、子标签数、创建时间 |
| 新建标签 | 点击"新建标签"，填写名称后创建成功 |
| 删除标签 | 选中标签，点击删除，标签从列表消失 |

### settings/minio.spec.ts（5 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/settings/minio`，显示 MinIO 实例列表 |
| 列表显示名称、Endpoint、状态 | 表格包含必要列和在线/离线状态 |
| 添加实例 | 点击"添加实例"，填写信息后创建成功 |
| 测试连接 | 点击实例的"测试连接"，显示连接结果 |
| 删除实例 | 点击删除，实例从列表消失 |

### settings/users.spec.ts（4 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常（管理员） | 管理员访问 `/settings/users`，显示用户列表 |
| 非管理员无法访问 | 普通用户访问，重定向或显示无权限提示 |
| 添加用户 | 点击"新增"，填写信息后创建成功 |
| 删除用户 | 点击删除，用户从列表消失 |

### settings/profile.spec.ts（5 个测试）

| 测试 | 说明 |
|------|------|
| 页面加载正常 | 访问 `/settings/profile`，显示个人设置 |
| 可修改姓名 | 修改姓名后保存，显示成功提示 |
| 可修改邮箱 | 修改邮箱后保存，显示成功提示 |
| 可修改密码 | 输入旧密码和新密码，保存成功 |
| 主题切换 | 切换深色/浅色模式，界面样式变化 |

---

## 7. 测试统计

| 模块 | 文件数 | 测试数 |
|------|--------|--------|
| 认证 | 3 | 14 |
| 导航 | 1 | 8 |
| 工作台 | 5 | 36 |
| 配置 | 4 | 19 |
| **总计** | **13** | **77** |

---

## 8. 实施步骤

1. **删除现有测试**：移除 `tests/*.spec.ts` 文件（保留 utils/、auth.setup.ts、config.ts）
2. **创建目录结构**：`tests/auth/`、`tests/workbench/`、`tests/settings/`
3. **按模块编写测试**：按本文档顺序逐个实现
4. **更新配置**：如需调整 `playwright.config.ts`

---

## 9. 测试约定

### 命名约定

- 文件名：`<feature>.spec.ts`
- 测试描述：使用中英双语正则匹配 UI 文本
- data-testid：用于不稳定元素定位

### 定位器优先级

1. `getByRole()` — 语义化、可访问性优先
2. `getByLabel()` — 表单字段
3. `getByText()` — 文本内容
4. `getByTestId()` — 不稳定元素

### 等待策略

- 使用 Playwright 自动重试断言
- 禁止使用 `page.waitForTimeout()`
- 导航使用 `page.waitForURL()`

---

## 10. 依赖假设

- 后端 API 已按新 UX 设计实现对应路由
- 前端页面组件已实现（或将实现）
- MinIO 测试实例可用（测试可优雅跳过）
- Mailcatcher 服务可用（用于邮件测试）
